---
/**
 * T061: Backtesting page
 * Historical trading strategy testing with comprehensive analytics
 */

import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import BacktestingForm from '../components/BacktestingForm.astro';
import TradingChart from '../components/TradingChart.astro';

const pageTitle = "Strategy Backtesting";
const pageDescription = "Test your AI trading strategies against historical market data with comprehensive performance analytics.";
---

<Layout title={pageTitle} description={pageDescription}>
  <Navigation currentPath="/backtesting" />

  <main class="min-h-screen bg-dark-bg">
    <!-- Header Section -->
    <div class="border-b border-neon-cyan/30 bg-dark-surface/50 backdrop-blur-sm">
      <div class="container mx-auto px-4 py-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
          <!-- Page Title -->
          <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-gradient-to-br from-neon-purple to-neon-pink rounded-xl flex items-center justify-center glow-border">
              <span class="text-2xl">üîÑ</span>
            </div>
            <div>
              <h1 class="text-3xl font-orbitron font-bold text-neon-purple glow-text">
                STRATEGY BACKTESTING
              </h1>
              <p class="text-text-secondary mt-1">
                Test AI strategies against historical market data
              </p>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="flex items-center space-x-4">
            <button class="bg-neon-purple/20 hover:bg-neon-purple/30 border border-neon-purple/50 text-neon-purple px-4 py-2 rounded-lg font-medium transition-colors duration-300">
              <span class="mr-2">üìÅ</span>
              Load Strategy
            </button>
            <button class="bg-neon-cyan/20 hover:bg-neon-cyan/30 border border-neon-cyan/50 text-neon-cyan px-4 py-2 rounded-lg font-medium transition-colors duration-300">
              <span class="mr-2">üíæ</span>
              Save Results
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Left Column: Backtesting Form -->
        <div class="lg:col-span-1 space-y-6">
          <!-- Backtesting Configuration -->
          <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-purple/30">
            <BacktestingForm />
          </div>

          <!-- Strategy Templates -->
          <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-cyan/30 p-6">
            <h3 class="text-lg font-orbitron font-bold text-neon-cyan mb-4 flex items-center">
              <span class="mr-2">üéØ</span>
              Strategy Templates
            </h3>

            <div class="space-y-3">
              <div class="bg-dark-surface/50 rounded-lg p-4 border border-neon-green/20 hover:border-neon-green/40 cursor-pointer transition-colors group">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <div class="text-white font-medium group-hover:text-neon-green transition-colors">Conservative AI</div>
                    <div class="text-xs text-text-muted">Low risk, steady gains</div>
                  </div>
                  <div class="text-right">
                    <div class="text-neon-green text-sm font-bold">+12.4%</div>
                    <div class="text-xs text-text-muted">avg. return</div>
                  </div>
                </div>
                <div class="text-xs text-text-secondary">
                  RSI + MA Cross + AI confidence > 75%
                </div>
              </div>

              <div class="bg-dark-surface/50 rounded-lg p-4 border border-neon-purple/20 hover:border-neon-purple/40 cursor-pointer transition-colors group">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <div class="text-white font-medium group-hover:text-neon-purple transition-colors">Aggressive Growth</div>
                    <div class="text-xs text-text-muted">High risk, high reward</div>
                  </div>
                  <div class="text-right">
                    <div class="text-neon-purple text-sm font-bold">+28.7%</div>
                    <div class="text-xs text-text-muted">avg. return</div>
                  </div>
                </div>
                <div class="text-xs text-text-secondary">
                  Momentum + Volume + AI confidence > 60%
                </div>
              </div>

              <div class="bg-dark-surface/50 rounded-lg p-4 border border-neon-cyan/20 hover:border-neon-cyan/40 cursor-pointer transition-colors group">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <div class="text-white font-medium group-hover:text-neon-cyan transition-colors">Scalping Pro</div>
                    <div class="text-xs text-text-muted">Short-term trades</div>
                  </div>
                  <div class="text-right">
                    <div class="text-neon-cyan text-sm font-bold">+19.2%</div>
                    <div class="text-xs text-text-muted">avg. return</div>
                  </div>
                </div>
                <div class="text-xs text-text-secondary">
                  1-5 min timeframes + AI signals
                </div>
              </div>

              <div class="bg-dark-surface/50 rounded-lg p-4 border border-neon-pink/20 hover:border-neon-pink/40 cursor-pointer transition-colors group">
                <div class="flex justify-between items-start mb-2">
                  <div>
                    <div class="text-white font-medium group-hover:text-neon-pink transition-colors">DCA Strategy</div>
                    <div class="text-xs text-text-muted">Dollar cost averaging</div>
                  </div>
                  <div class="text-right">
                    <div class="text-neon-pink text-sm font-bold">+15.8%</div>
                    <div class="text-xs text-text-muted">avg. return</div>
                  </div>
                </div>
                <div class="text-xs text-text-secondary">
                  Regular buys + AI market timing
                </div>
              </div>
            </div>
          </div>

          <!-- Risk Metrics -->
          <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-pink/30 p-6">
            <h3 class="text-lg font-orbitron font-bold text-neon-pink mb-4 flex items-center">
              <span class="mr-2">‚ö†Ô∏è</span>
              Risk Analysis
            </h3>

            <div class="space-y-4">
              <!-- Sharpe Ratio -->
              <div class="flex justify-between items-center">
                <span class="text-text-secondary">Sharpe Ratio</span>
                <span class="text-neon-green font-bold">1.42</span>
              </div>
              <div class="w-full bg-dark-surface/50 rounded-full h-2">
                <div class="bg-gradient-to-r from-neon-cyan to-neon-green h-2 rounded-full" style="width: 71%"></div>
              </div>

              <!-- Max Drawdown -->
              <div class="flex justify-between items-center">
                <span class="text-text-secondary">Max Drawdown</span>
                <span class="text-neon-pink font-bold">-8.3%</span>
              </div>
              <div class="w-full bg-dark-surface/50 rounded-full h-2">
                <div class="bg-gradient-to-r from-neon-pink to-neon-purple h-2 rounded-full" style="width: 17%"></div>
              </div>

              <!-- Win Rate -->
              <div class="flex justify-between items-center">
                <span class="text-text-secondary">Win Rate</span>
                <span class="text-neon-cyan font-bold">64.7%</span>
              </div>
              <div class="w-full bg-dark-surface/50 rounded-full h-2">
                <div class="bg-gradient-to-r from-neon-cyan to-neon-purple h-2 rounded-full" style="width: 65%"></div>
              </div>

              <!-- Volatility -->
              <div class="flex justify-between items-center">
                <span class="text-text-secondary">Volatility</span>
                <span class="text-neon-purple font-bold">12.4%</span>
              </div>
              <div class="w-full bg-dark-surface/50 rounded-full h-2">
                <div class="bg-gradient-to-r from-neon-purple to-neon-pink h-2 rounded-full" style="width: 31%"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Results -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Performance Chart -->
          <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-cyan/30 glow-border">
            <div class="p-4 border-b border-neon-cyan/20">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <h2 class="text-xl font-orbitron font-bold text-neon-cyan flex items-center">
                  <span class="mr-2">üìä</span>
                  BACKTEST RESULTS
                </h2>
                <div class="flex items-center space-x-4">
                  <!-- Period Selector -->
                  <select class="bg-dark-surface/50 border border-neon-cyan/30 text-white rounded-lg px-3 py-1 text-sm focus:outline-none focus:border-neon-cyan">
                    <option>Last 30 Days</option>
                    <option>Last 3 Months</option>
                    <option>Last 6 Months</option>
                    <option>Last Year</option>
                    <option>All Time</option>
                  </select>

                  <!-- Export Button -->
                  <button class="bg-neon-cyan/20 hover:bg-neon-cyan/30 border border-neon-cyan/50 text-neon-cyan px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                    Export CSV
                  </button>
                </div>
              </div>
            </div>
            <div class="h-96">
              <TradingChart coinSymbol="bitcoin" />
            </div>
          </div>

          <!-- Summary Statistics -->
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
            <!-- Total Return -->
            <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-green/30 p-6">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-text-secondary text-sm">Total Return</div>
                  <div class="text-2xl font-bold text-neon-green">+24.7%</div>
                  <div class="text-xs text-neon-green mt-1">+$12,350</div>
                </div>
                <div class="text-3xl">üìà</div>
              </div>
            </div>

            <!-- Total Trades -->
            <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-cyan/30 p-6">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-text-secondary text-sm">Total Trades</div>
                  <div class="text-2xl font-bold text-neon-cyan">1,247</div>
                  <div class="text-xs text-neon-cyan mt-1">avg 12/day</div>
                </div>
                <div class="text-3xl">üîÑ</div>
              </div>
            </div>

            <!-- Best Trade -->
            <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-purple/30 p-6">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-text-secondary text-sm">Best Trade</div>
                  <div class="text-2xl font-bold text-neon-purple">+$2,841</div>
                  <div class="text-xs text-neon-purple mt-1">BTC/USDT</div>
                </div>
                <div class="text-3xl">üöÄ</div>
              </div>
            </div>

            <!-- Avg Hold Time -->
            <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-pink/30 p-6">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-text-secondary text-sm">Avg Hold Time</div>
                  <div class="text-2xl font-bold text-neon-pink">4.2h</div>
                  <div class="text-xs text-neon-pink mt-1">median 2.8h</div>
                </div>
                <div class="text-3xl">‚è±Ô∏è</div>
              </div>
            </div>
          </div>

          <!-- Trade History Table -->
          <div class="cyberpunk-card bg-dark-card/90 backdrop-blur-md rounded-xl border border-neon-cyan/30">
            <div class="p-4 border-b border-neon-cyan/20">
              <h3 class="text-lg font-orbitron font-bold text-neon-cyan flex items-center justify-between">
                <span class="flex items-center">
                  <span class="mr-2">üìù</span>
                  Recent Trades
                </span>
                <button class="text-xs bg-neon-cyan/20 hover:bg-neon-cyan/30 border border-neon-cyan/50 text-neon-cyan px-3 py-1 rounded-lg transition-colors">
                  View All
                </button>
              </h3>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-dark-surface/30">
                  <tr class="text-left text-text-secondary text-sm">
                    <th class="p-4">Date</th>
                    <th class="p-4">Pair</th>
                    <th class="p-4">Type</th>
                    <th class="p-4">Entry</th>
                    <th class="p-4">Exit</th>
                    <th class="p-4">P&L</th>
                    <th class="p-4">Duration</th>
                  </tr>
                </thead>
                <tbody class="text-sm">
                  <tr class="border-b border-neon-cyan/10 hover:bg-dark-surface/20 transition-colors">
                    <td class="p-4 text-text-muted">Dec 18, 14:32</td>
                    <td class="p-4 text-white font-medium">BTC/USDT</td>
                    <td class="p-4"><span class="text-neon-green bg-neon-green/10 px-2 py-1 rounded text-xs">LONG</span></td>
                    <td class="p-4 text-white">$42,150</td>
                    <td class="p-4 text-white">$43,521</td>
                    <td class="p-4 text-neon-green font-bold">+$1,371</td>
                    <td class="p-4 text-text-muted">2.4h</td>
                  </tr>
                  <tr class="border-b border-neon-cyan/10 hover:bg-dark-surface/20 transition-colors">
                    <td class="p-4 text-text-muted">Dec 18, 11:15</td>
                    <td class="p-4 text-white font-medium">ETH/USDT</td>
                    <td class="p-4"><span class="text-neon-pink bg-neon-pink/10 px-2 py-1 rounded text-xs">SHORT</span></td>
                    <td class="p-4 text-white">$2,890</td>
                    <td class="p-4 text-white">$2,834</td>
                    <td class="p-4 text-neon-green font-bold">+$560</td>
                    <td class="p-4 text-text-muted">1.8h</td>
                  </tr>
                  <tr class="border-b border-neon-cyan/10 hover:bg-dark-surface/20 transition-colors">
                    <td class="p-4 text-text-muted">Dec 18, 09:42</td>
                    <td class="p-4 text-white font-medium">ADA/USDT</td>
                    <td class="p-4"><span class="text-neon-green bg-neon-green/10 px-2 py-1 rounded text-xs">LONG</span></td>
                    <td class="p-4 text-white">$0.452</td>
                    <td class="p-4 text-white">$0.441</td>
                    <td class="p-4 text-neon-pink font-bold">-$110</td>
                    <td class="p-4 text-text-muted">4.7h</td>
                  </tr>
                  <tr class="border-b border-neon-cyan/10 hover:bg-dark-surface/20 transition-colors">
                    <td class="p-4 text-text-muted">Dec 17, 16:28</td>
                    <td class="p-4 text-white font-medium">SOL/USDT</td>
                    <td class="p-4"><span class="text-neon-green bg-neon-green/10 px-2 py-1 rounded text-xs">LONG</span></td>
                    <td class="p-4 text-white">$98.50</td>
                    <td class="p-4 text-white">$102.34</td>
                    <td class="p-4 text-neon-green font-bold">+$384</td>
                    <td class="p-4 text-text-muted">6.2h</td>
                  </tr>
                  <tr class="hover:bg-dark-surface/20 transition-colors">
                    <td class="p-4 text-text-muted">Dec 17, 13:11</td>
                    <td class="p-4 text-white font-medium">DOT/USDT</td>
                    <td class="p-4"><span class="text-neon-pink bg-neon-pink/10 px-2 py-1 rounded text-xs">SHORT</span></td>
                    <td class="p-4 text-white">$7.82</td>
                    <td class="p-4 text-white">$7.65</td>
                    <td class="p-4 text-neon-green font-bold">+$170</td>
                    <td class="p-4 text-text-muted">3.1h</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Running Test Modal (Hidden by default) -->
    <div id="test-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
      <div class="cyberpunk-card bg-dark-card/95 backdrop-blur-md rounded-xl border border-neon-purple/30 p-8 max-w-md w-full mx-4">
        <div class="text-center">
          <div class="w-16 h-16 bg-gradient-to-br from-neon-purple to-neon-cyan rounded-full flex items-center justify-center mx-auto mb-4 glow-border">
            <div class="animate-spin w-8 h-8 border-4 border-neon-purple border-t-transparent rounded-full"></div>
          </div>
          <h3 class="text-xl font-orbitron font-bold text-neon-purple mb-2">
            RUNNING BACKTEST
          </h3>
          <p class="text-text-secondary mb-4">
            Testing strategy against historical data...
          </p>
          <div class="bg-dark-surface/50 rounded-lg p-4 mb-4">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-text-secondary">Progress</span>
              <span class="text-neon-cyan" id="progress-text">0%</span>
            </div>
            <div class="w-full bg-dark-surface rounded-full h-2">
              <div class="bg-gradient-to-r from-neon-cyan to-neon-purple h-2 rounded-full transition-all duration-1000" id="progress-bar" style="width: 0%"></div>
            </div>
          </div>
          <button id="cancel-test" class="bg-neon-pink/20 hover:bg-neon-pink/30 border border-neon-pink/50 text-neon-pink px-6 py-2 rounded-lg font-medium transition-colors">
            Cancel Test
          </button>
        </div>
      </div>
    </div>
  </main>

  <!-- Backtesting Logic Script -->
  <script>
    // @ts-nocheck
    document.addEventListener('DOMContentLoaded', function() {
      const testModal = document.getElementById('test-modal');
      const progressBar = document.getElementById('progress-bar');
      const progressText = document.getElementById('progress-text');
      const cancelButton = document.getElementById('cancel-test');

      // Simulate backtest when form is submitted
      document.addEventListener('submit', function(e) {
        const target = e.target as HTMLFormElement;
        if (target && target.id === 'backtest-form') {
          e.preventDefault();
          startBacktest();
        }
      });

      function startBacktest() {
        if (testModal) {
          testModal.classList.remove('hidden');
          let progress = 0;

          const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress >= 100) {
              progress = 100;
              clearInterval(interval);
              setTimeout(() => {
                testModal.classList.add('hidden');
                // Show results (in real app, would update the charts/data)
                alert('Backtest completed! Results updated.');
              }, 500);
            }

            if (progressBar) progressBar.style.width = progress + '%';
            if (progressText) progressText.textContent = Math.round(progress) + '%';
          }, 200);

          // Cancel button handler
          if (cancelButton) {
            cancelButton.onclick = () => {
              clearInterval(interval);
              testModal.classList.add('hidden');
            };
          }
        }
      }

      // Strategy template selection
      document.querySelectorAll('.cursor-pointer[class*="border-"]').forEach(template => {
        template.addEventListener('click', function() {
          // Remove active state from all templates
          document.querySelectorAll('.cursor-pointer[class*="border-"]').forEach(t => {
            t.classList.remove('ring-2', 'ring-neon-cyan');
          });
          // Add active state to clicked template
          this.classList.add('ring-2', 'ring-neon-cyan');

          // In real app, would populate form with template settings
          console.log('Template selected:', this.querySelector('.font-medium').textContent);
        });
      });
    });
  </script>

  <style>
    /* Cyberpunk card effects */
    .cyberpunk-card {
      position: relative;
      transition: all 0.3s ease;
    }

    .cyberpunk-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 32px rgba(0, 255, 255, 0.1);
    }

    .cyberpunk-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(0, 255, 255, 0.03) 50%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .cyberpunk-card:hover::before {
      opacity: 1;
    }

    /* Table styling */
    table {
      border-collapse: separate;
      border-spacing: 0;
    }

    /* Modal animations */
    #test-modal {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Progress bar glow */
    #progress-bar {
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }
  </style>
</Layout>